echo "🚀 Running pre-commit checks..."
echo "🔍 TypeScript → 🧹 Linting → 🧪 Testing → 🏗️ Building → 📊 SonarQube"

# Check current branch and warn about main branch commits (local protection)
CURRENT_BRANCH=$(git branch --show-current)
if [ "$CURRENT_BRANCH" = "main" ]; then
  echo "⚠️  WARNING: Committing directly to main branch!"
  echo "🔄 Consider using the worktree workflow:"
  echo "   npm run worktree:create <task-name>"
  echo "   cd worktrees/<task-name>"
  echo "   npm run commit \"your message\""
  echo ""
  echo "⏸️  Proceeding anyway in 3 seconds... (Ctrl+C to cancel)"
  sleep 3
fi

# Check for unstaged changes before running any checks
if ! git diff --quiet; then
  echo "❌ You have unstaged changes. Please stage all changes before committing:"
  echo ""
  git diff --name-only
  echo ""
  echo "Run: git add -A"
  exit 1
fi

# Run the pre-commit checks
npm run pre-commit

if [ $? -eq 0 ]; then
  # After all checks pass, verify no new changes were introduced
  if ! git diff --quiet; then
    echo "❌ Linting or other tools modified files during pre-commit checks."
    echo "Files that were modified:"
    git diff --name-only
    echo ""
    echo "Please stage these changes and commit again:"
    echo "git add -A && git commit --amend --no-edit"
    exit 1
  fi
  echo "✅ All pre-commit checks passed!"
else
  echo "❌ Pre-commit checks failed. Commit aborted."
  exit 1
fi

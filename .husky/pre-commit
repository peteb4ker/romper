echo "ğŸš€ Running pre-commit checks..."
echo "ğŸ” TypeScript â†’ ğŸ§¹ Linting â†’ ğŸ§ª Testing â†’ ğŸ—ï¸ Building â†’ ğŸ“Š SonarQube"

# Check current branch and warn about main branch commits (local protection)
CURRENT_BRANCH=$(git branch --show-current)
if [ "$CURRENT_BRANCH" = "main" ]; then
  echo "âš ï¸  WARNING: Committing directly to main branch!"
  echo "ğŸ”„ Consider using the worktree workflow:"
  echo "   npm run worktree:create <task-name>"
  echo "   cd worktrees/<task-name>"
  echo "   npm run commit \"your message\""
  echo ""
  echo "â¸ï¸  Proceeding anyway in 3 seconds... (Ctrl+C to cancel)"
  sleep 3
fi

# Check for unstaged changes before running any checks
if ! git diff --quiet; then
  echo "âŒ You have unstaged changes. Please stage all changes before committing:"
  echo ""
  git diff --name-only
  echo ""
  echo "Run: git add -A"
  exit 1
fi

# Run the pre-commit checks
npm run pre-commit

if [ $? -eq 0 ]; then
  # After all checks pass, verify no new changes were introduced
  if ! git diff --quiet; then
    echo "âŒ Linting or other tools modified files during pre-commit checks."
    echo "Files that were modified:"
    git diff --name-only
    echo ""
    echo "Please stage these changes and commit again:"
    echo "git add -A && git commit --amend --no-edit"
    exit 1
  fi
  echo "âœ… All pre-commit checks passed!"
else
  echo "âŒ Pre-commit checks failed. Commit aborted."
  exit 1
fi

## Relevant Files

- `src/renderer/components/KitBrowser.tsx` - Main kit browser UI, kit navigation, and kit list rendering.
- `src/renderer/components/KitDetails.tsx` - Kit detail page, voice/slot management, and sample assignment.
- `src/renderer/components/KitVoicePanel.tsx` - UI for managing voices and sample slots within a kit.
- `src/renderer/components/KitVoicePanels.tsx` - Renders all 4 KitVoicePanel components and centralizes cross-voice navigation logic.
- `src/renderer/components/SampleWaveform.tsx` - Displays waveform previews for samples.
- `src/renderer/components/StatusBar.tsx` - Status bar for progress indicators and messages.
- `src/renderer/components/KitDialogs.tsx` - Dialogs for warnings, errors, confirmations, and factory restore.
- `src/renderer/components/KitBankNav.tsx` - A-Z bank navigation UI and hotkey handling.
- `src/renderer/components/hooks/useKitDetails.ts` - Business logic for kit details and sample management.
- `src/renderer/components/hooks/useKitItem.ts` - Business logic for kit type inference and metadata display.
- `src/renderer/components/hooks/useKitPlan.ts` - Business logic for kit plan creation, duplication, and editing.
- `src/renderer/components/hooks/useSamplePreview.ts` - Business logic for sample and kit previewing.
- `src/renderer/components/hooks/useKitPreview.ts` - Business logic for full kit preview playback (MIDI test pattern), play/stop state, and error handling.
- `src/renderer/components/utils/settingsManager.ts` - Manages app settings (e.g., stereo/mono toggle, theme persistence).
- `src/renderer/components/__tests__/KitBrowser.test.tsx` - Unit tests for kit browser UI and navigation.
- `src/renderer/components/__tests__/KitDetails.test.tsx` - Unit tests for kit detail page and sample assignment.
- `src/renderer/components/__tests__/KitVoicePanel.test.tsx` - Unit tests for KitVoicePanel sample slot selection and keyboard navigation. Now focused only on single-voice panel logic; multi-voice/cross-panel tests have been moved to KitVoicePanels.test.tsx for clarity and separation of concerns.
- `src/renderer/components/__tests__/KitVoicePanels.test.tsx` - Unit tests for KitVoicePanels, covering multi-voice/cross-panel navigation and integration scenarios (newly created as part of this refactor).
- `src/renderer/components/__tests__/SampleWaveform.test.tsx` - Unit tests for waveform preview.
- `src/renderer/components/__tests__/StatusBar.test.tsx` - Unit tests for status bar and progress indicators.
- `src/renderer/components/__tests__/KitDialogs.test.tsx` - Unit tests for dialogs and error handling.
- `src/renderer/components/__tests__/KitBankNav.test.tsx` - Unit tests for A-Z navigation and hotkeys.
- `src/renderer/components/hooks/__tests__/useKitDetails.test.ts` - Unit tests for kit details logic.
- `src/renderer/components/hooks/__tests__/useKitItem.test.ts` - Unit tests for kit type inference logic.
- `src/renderer/components/hooks/__tests__/useKitPlan.test.ts` - Unit tests for kit plan logic.
- `src/renderer/components/hooks/__tests__/useSamplePreview.test.ts` - Unit tests for preview logic.
- `src/renderer/components/utils/__tests__/settingsManager.test.ts` - Unit tests for settings management.
- `electron/main/index.ts` - Type safety improvements for inMemorySettings and currentSamplePlayer.

### Notes

- Unit tests should be placed alongside the code files they are testing (e.g., `MyComponent.tsx` and `MyComponent.test.tsx` in the same directory).
- Use `npx vitest` to run tests. Running without a path executes all tests found by the Vitest configuration.

## Tasks

- [x] 1.0 Implement UI/UX Structure and Navigation
  - [x] 1.1 Implement main kit browser and kit detail page
    - [x] 1.1.1 Build kit browser UI with kit list and navigation
    - [x] 1.1.2 Build kit detail page for voice/slot/sample management
    - [x] 1.1.3 Write unit tests for browser and detail page navigation
  - [x] 1.2 Place action buttons at the top of the page
    - [x] 1.2.1 Add action buttons (create, duplicate, sync, etc.) to top bar
    - [x] 1.2.2 Write unit tests for action button functionality
  - [x] 1.3 Implement status bar at the bottom with pertinent information (including progress indicators)
    - [x] 1.3.1 Build status bar UI and integrate progress indicators
    - [x] 1.3.2 Write unit tests for status bar and progress
  - [x] 1.4 Display information, error, and warning messages in a central location at the top of the screen
    - [x] 1.4.1 Centralize message display logic
    - [x] 1.4.2 Style messages according to type (info, warning, error)
    - [x] 1.4.3 Write unit tests for message display
  - [x] 1.5 Implement A-Z hotkeys and UI for bank navigation
    - [x] 1.5.2 Highlight selected bank in UI
    - [x] 1.5.3 Write unit tests for hotkey navigation
    - [x] 1.5.4 Fix: A-Z hotkeys must move keyboard focus to the first kit in the selected bank
  - [x] 1.6 Implement keyboard navigation for sample slots
      [x] 1.6.1 Remove all kit and voice keyboard navigation from the app. A-Z bank navigation should remain.
    - [x] 1.6.3 Implement keyboard navigation for sample slots (up/down arrows, space)
      - [x] 1.6.3.1 Add keyboard event handlers for sample slot navigation (up/down, space)
      - [x] 1.6.3.2 Disable navigation at first/last slot as appropriate
      - [x] 1.6.3.3 Ensure selection highlight and focus update correctly on navigation
      - [x] 1.6.3.4 Write unit tests for sample slot keyboard navigation (including edge cases)
  - [x] 1.7 Implement persistent light/dark mode toggle
    - [x] 1.7.1 Add toggle UI and persist theme setting
    - [x] 1.7.2 Write unit tests for theme toggle and persistence
  - [x] 1.8 Add link to Squarp Rample manual (opens in system browser)
    - [x] 1.8.1 Add external link to manual in UI
    - [x] 1.8.2 Write unit tests for manual link
  - [x] 1.12 Precompute and memoize kit sample counts and voice label sets in kit browser for performance
    - [x] 1.12.1 Compute these values once per kit list load/change, not on every render
    - [x] 1.12.2 Pass precomputed values as props to KitList/KitItem
    - [x] 1.12.3 Write unit tests to verify memoization and correct display
  - [x] 1.13 Voice panels clearly indicate the slot number, and there is no confusion between the slot number and the sample name, especially if the sample name starts with a number.
    - [x] 1.13.1 Slot numbers take up a uniform amount of space so the play buttons, filenames and waveforms are all aligned.
  - [x] 1.14 The 4 voice panels are laid out in a single row of 4 columns, left to right across the screen.
  - [x] 1.15 Within the voice panel, the sample list is in a single column.
  - [x] 1.16 Each voice has exactly 12 slots.  If a sample is not assigned, an empty slot is shown.
    - [x] 1.16.1 An empty slot is the same height as a slot with an assigned sample

- [ ] 2.0 Implement Kit Planning and Metadata Management
 - Defined in `tasks/task-plans-PRD.md`

- [x] 3.0 Implement Previewing and Audio Features
  - [x] 3.1 Implement preview for individual `.wav` samples (UI and audio engine)
    - [x] 3.1.1 Add play/stop controls for samples in UI
    - [x] 3.1.2 Integrate audio playback engine for `.wav` files
    - [x] 3.1.3 Write unit tests for sample preview logic
  - [x] 3.2 Implement preview for full kits
    - [x] 3.2.2 Implement 4-channel, 16-step XOX-style step sequencer for kit preview
      - [x] 3.2.2.1 Render a 4x16 step grid at the bottom of KitDetails, color-coded by voice.
         - [x] 3.2.2.1.1 The step buttons are square
         - [x] 3.2.2.1.2 The step buttons should ideally look like backlit LED buttons when lit.
         - [x] 3.2.2.1.3 The grid is fixed and is not responsive to UI resizing
         - [x] 3.2.2.1.4 The step sequencer should be visually different to the rest of the application, appearing as if its coming out of a drawer at the bottom of the app.  clicking on the edge of the control should show and hide it via animation.
         - [x] 3.2.2.1.5 The step sequencer should be centered in the middle of its parent control
         - [x] 3.2.2.1.6 There should be a visual separation between each 4 of the 16 steps to indicate that its a beat in the bar
         - [x] 3.2.2.1.7 Its possible to show and hide the step sequencer.
       - [x] 3.2.2.2 Allow mouse and keyboard navigation/toggling of steps (arrow keys, spacebar)
      - [x] 3.2.2.3 Implement play/stop controls for sequencer playback (looping at 120 BPM)
        - [] 3.2.2.3.1 Play control and BPM label should be to the left of the grid to optimize whitespace in the sequencer drawer
      - [x] 3.2.2.4 Play first sample in each voice for each active step; mute if no sample
      - [x] 3.2.2.5 Persist pattern per kit in labels JSON file
      - [x] 3.2.2.6 Unit tests for sequencer UI, playback, persistence, and navigation
      - [x] 3.2.2.7 The sequencer is hidden by default.
  - [x] 3.3 Display waveform view for each sample in the UI
    - [x] 3.3.1 Render waveform for each sample slot
    - [x] 3.3.2 Write unit tests for waveform rendering
  - [x] 3.4 Implement keyboard navigation for previewing (spacebar to preview sample)
    - [x] 3.4.1 Add keyboard event handlers for sample preview
    - [x] 3.4.3 Browser focus / accessibility is not important for keyboard navigation. Custom selection is fine.
    - [x] 3.4.4 One sample per kit should be selectable at any time.  Going down beyond the end of a voice should move selection to the top of the next voice
    - [x] 3.4.5 Keyboard navigation should always take precedence over screen scrolling
    - [x] 3.4.6 Keyboard navigation should work independently from sequencer navigation.  if the sequencer navigation is active, waveform navigation is ignored, if waveform navigation is active, sequencer navigation is ignored
    - [x] 3.4.7 When selection moves to the first sample in a voice, subsequent up/down navigation should work as expected and not scroll the app
  - [x] 3.5 Disable sequencer keyboard navigation when the sequencer is closed.
  - [x] 3.6 Enable sample navigation when the sequencer is closed.
  - [x] 3.7 Enable sequencer keyboard navigation when the sequencer is open.
  - [x] 3.8 Disable sample navigation when the sequencer is open.
  - [x] 3.9 When opening or closing the sequencer, the selection focus should always immediately switch so the user can start keyboard nabigation straight away, and not need to click on the sequencer to give it focus.
  - [x] 3.10 Hitting the 'S' key opens and closes the sequencer.

- [ ] 4.0 Implement SD Card Sync and File Operations
  - [ ] 4.1 Implement option to initialize app state from SD card
    - [ ] 4.1.1 Scan SD card for existing kits and samples
    - [ ] 4.1.2 Initialize local metadata from SD card contents
    - [ ] 4.1.3 Write unit tests for SD card initialization
  - [ ] 4.2 Only allow sync when SD card is mounted
    - [ ] 4.2.1 Detect SD card mount/unmount events
    - [ ] 4.2.2 Enable/disable sync actions based on SD card state
    - [ ] 4.2.3 Write unit tests for SD card detection logic
  - [ ] 4.3 Prevent sync if any samples in the plan are missing from disk
    - [ ] 4.3.1 Check for missing samples before sync
    - [ ] 4.3.2 Block sync and display warning if missing
    - [ ] 4.3.3 Write unit tests for sync prevention logic
  - [ ] 4.4 Copy samples destructively to SD card (after user confirmation)
    - [ ] 4.4.1 Prompt user for confirmation before destructive sync
    - [ ] 4.4.2 Copy samples and metadata to SD card, deleting old data as needed
    - [ ] 4.4.3 Write unit tests for destructive sync workflow
  - [ ] 4.5 Sync both metadata and sample files to SD card
    - [ ] 4.5.1 Ensure both sample files and metadata are copied
    - [ ] 4.5.2 Write unit tests for sync completeness
  - [ ] 4.6 Implement SD card folder structure and kit validation logic
    - [ ] 4.6.1 Enforce Rample SD card folder structure (banks, kits, voices)
    - [ ] 4.6.2 Validate kit folders and sample files before sync
    - [ ] 4.6.3 Write unit tests for folder structure and validation
  - [ ] 4.7 Implement factory sample restore workflow with warning, progress, and error handling
    - [ ] 4.7.1 Add UI for factory restore with warning dialog
    - [ ] 4.7.2 Download and unzip factory sample pack
    - [ ] 4.7.3 Replace user folders with factory samples, rescan metadata
    - [ ] 4.7.4 Show progress indicator and handle errors gracefully
    - [ ] 4.7.5 Write unit tests for factory restore workflow

- [ ] 5.0 Implement Sample Management Features
  - [ ] 5.1 Implement drag-and-drop sample assignment to kit voices/slots in the UI
    - [ ] 5.1.1 Add drag-and-drop handlers to kit voice/slot UI components
    - [ ] 5.1.2 Provide visual feedback (highlight/placeholder) during drag-over
    - [ ] 5.1.3 Support multi-file drop, enforcing slot limits and warnings
    - [ ] 5.1.4 Write unit tests for drag-and-drop assignment and feedback
  - [ ] 5.2 Enforce 4 voices per kit and up to 12 slots per voice in the UI
    - [ ] 5.2.2 Limit each voice to 12 sample slots
    - [ ] 5.2.3 Display warnings if slot/voice limits are exceeded
    - [ ] 5.2.4 Write unit tests for slot/voice enforcement and warnings
  - [ ] 5.3 Validate dropped files as `.wav` and display warnings for invalid files
    - [ ] 5.3.1 Check file extensions on drop
    - [ ] 5.3.2 Ignore invalid files and show warning message
    - [ ] 5.3.3 Write unit tests for file validation and warning display
  - [ ] 5.4 Prevent duplicate samples in a voice and warn for duplicates across voices
    - [ ] 5.4.1 Check for duplicate samples within a voice and prevent assignment
    - [ ] 5.4.2 Allow but warn for duplicates across voices in a kit
    - [ ] 5.4.3 Write unit tests for duplicate detection and warnings
  - [ ] 5.5 Implement stereo/mono handling and global/per-sample toggles
    - [ ] 5.5.1 Add global stereo/mono toggle in app settings
    - [ ] 5.5.2 Allow per-sample stereo/mono override in sample list
    - [ ] 5.5.3 Implement logic for stereo sample slot assignment (fills two slots/voices)
    - [ ] 5.5.4 Convert stereo samples to mono on SD sync if needed
    - [ ] 5.5.5 Write unit tests for stereo/mono toggles and assignment logic
  - [ ] 5.6 Store kit plan/sample assignment metadata in SQLite and persist changes immediately
    - [ ] 5.6.1 Integrate `better-sqlite3` for local metadata storage
    - [ ] 5.6.2 Persist all kit/sample assignment changes immediately
    - [ ] 5.6.3 Write unit tests for persistence and data integrity
  - [ ] 5.7 Display warnings/errors for slot/voice limit violations and duplicate samples
    - [ ] 5.7.1 Centralize warning/error display at top of app
    - [ ] 5.7.2 Ensure all relevant warnings/errors are triggered by UI actions
    - [ ] 5.7.3 Write unit tests for warning/error display

- [ ] 6.0 Implement Error Handling, Edge Cases, and Non-Functional Requirements
  - [ ] 6.1 Handle invalid/corrupt `.wav` files gracefully
    - [ ] 6.1.1 Detect and warn about invalid/corrupt files
    - [ ] 6.1.2 Prevent assignment/sync of invalid files
    - [ ] 6.1.3 Write unit tests for invalid file handling
  - [ ] 6.2 Handle SD card removal during sync or file operations
    - [ ] 6.2.1 Detect SD card removal events
    - [ ] 6.2.2 Pause/cancel file operations and warn user
    - [ ] 6.2.3 Write unit tests for SD card removal handling
  - [ ] 6.3 Handle duplicate sample names or hash collisions
    - [ ] 6.3.1 Detect duplicate names/hashes and warn user
    - [ ] 6.3.2 Write unit tests for duplicate name/hash handling
  - [ ] 6.4 Handle slot/voice limit violations with user feedback
    - [ ] 6.4.1 Detect and warn about slot/voice limit violations
    - [ ] 6.4.2 Write unit tests for limit violation handling
  - [ ] 6.5 Handle missing samples when opening or syncing a kit plan
    - [ ] 6.5.1 Detect missing samples on kit open/sync
    - [ ] 6.5.2 Block actions and display warning if missing
    - [ ] 6.5.3 Write unit tests for missing sample handling
  - [ ] 6.6 Ensure sub-50ms UI interaction delay
    - [ ] 6.6.1 Profile and optimize UI for responsiveness
    - [ ] 6.6.2 Write performance tests for UI delay
  - [ ] 6.7 Ensure no user data is collected or sent externally
    - [ ] 6.7.1 Audit code for data collection
    - [ ] 6.7.2 Write unit tests to verify no external data is sent
  - [ ] 6.8 Ensure no cloud sync or external network access
    - [ ] 6.8.1 Audit code for network access
    - [ ] 6.8.2 Write unit tests to verify no network access
  - [ ] 6.9 Ensure the app is standalone and only interacts with the SD card
    - [ ] 6.9.1 Audit code for external dependencies
    - [ ] 6.9.2 Write unit tests for SD card-only interaction
  - [ ] 6.10 Ensure destructive sync is only allowed after confirmation and local backup
    - [ ] 6.10.1 Require user confirmation and backup before destructive sync
    - [ ] 6.10.2 Write unit tests for destructive sync confirmation
  - [ ] 6.11 Ensure no multi-user or multi-computer sync is required
    - [ ] 6.11.1 Audit code for multi-user/multi-computer logic
    - [ ] 6.11.2 Write unit tests to verify single-user operation

- [ ] 7.0 Implement Testing, Quality Assurance, and Release Workflow
  - [ ] 7.1 Implement unit tests for all business logic (using vitest)
    - [ ] 7.1.1 Write unit tests for all hooks, utils, and UI logic
    - [ ] 7.1.2 Ensure all test files are isolated and DRY
  - [ ] 7.2 Achieve at least 80% code coverage
    - [ ] 7.2.1 Add/expand tests to reach 80% coverage
    - [ ] 7.2.2 Use coverage reports to identify gaps
  - [ ] 7.3 Implement at least one integration test to verify the application loads successfully
    - [ ] 7.3.1 Write integration test for app load
  - [ ] 7.4 Add tests for A-Z hotkey navigation
    - [ ] 7.4.1 Write tests for A-Z hotkey navigation in kit browser
  - [ ] 7.5 Add tests for info/error/warning message display
    - [ ] 7.5.1 Write tests for message display logic
  - [ ] 7.6 Add tests for kit locking/prevent overwrite
    - [ ] 7.6.1 Write tests for kit locking and prevention
  - [ ] 7.7 Add tests for tagging/favoriting
    - [ ] 7.7.1 Write tests for tagging/favoriting logic
  - [ ] 7.8 Add tests for missing sample detection/warning
    - [ ] 7.8.1 Write tests for missing sample detection and warning
  - [ ] 7.9 Implement GitHub release workflow for app distribution
    - [ ] 7.9.1 Set up GitHub Actions for build and release
    - [ ] 7.9.2 Write documentation for release workflow
  - [ ] 7.10 Ensure macOS distribution is working
    - [ ] 7.10.1 Test and verify macOS build/distribution
  - [ ] 7.11 Implement Windows distribution
    - [ ] 7.11.1 Test and verify Windows build/distribution
